<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test AI Analysis for Multiple Observations</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .observation-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .observation-card.processing {
            background: #fff3cd;
        }
        .observation-card.success {
            background: #d4edda;
        }
        .observation-card.error {
            background: #f8d7da;
        }
        .observation-card.cached {
            background: #e8f4fd;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.cached {
            background: #17a2b8;
            color: white;
        }
        .status.new {
            background: #28a745;
            color: white;
        }
        .status.error {
            background: #dc3545;
            color: white;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
            border: 1px solid #b3d9ff;
        }
    </style>
</head>
<body>
    <h1>Test AI Analysis for Multiple Observations</h1>
    <p>This test verifies that AI analysis works for ANY observation ID, not just specific ones.</p>
    
    <div class="controls">
        <button onclick="fetchObservations()">1. Fetch All Observations</button>
        <button onclick="testAllObservations()" id="testAllBtn" disabled>2. Test AI Analysis for All</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div id="summary" class="summary" style="display: none;">
        <h3>Summary</h3>
        <div id="summaryContent"></div>
    </div>
    
    <div id="observations"></div>
    
    <script>
        let observations = [];
        let authToken = null;
        
        async function login() {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: 'admin@plp456.com',
                    password: 'Admin@456'
                }),
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Login failed');
            }
            return true;
        }
        
        async function fetchObservations() {
            const container = document.getElementById('observations');
            container.innerHTML = '<p>Logging in and fetching observations...</p>';
            
            try {
                await login();
                
                // Fetch list of observations
                const response = await fetch('/api/observations', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch observations');
                }
                
                const data = await response.json();
                observations = data.observations || data;
                
                if (!Array.isArray(observations)) {
                    throw new Error('Invalid observations data');
                }
                
                container.innerHTML = `<h3>Found ${observations.length} Observations</h3>`;
                
                // Display each observation
                observations.slice(0, 10).forEach(obs => {
                    const card = document.createElement('div');
                    card.className = 'observation-card';
                    card.id = `obs-${obs.id}`;
                    card.innerHTML = `
                        <h4>Observation: ${obs.id}</h4>
                        <p><strong>Teacher:</strong> ${obs.nameOfTeacher || 'N/A'}</p>
                        <p><strong>School:</strong> ${obs.school || 'N/A'}</p>
                        <p><strong>Subject:</strong> ${obs.subject || 'N/A'}</p>
                        <p><strong>Grade:</strong> ${obs.grade || 'N/A'}</p>
                        <div id="analysis-${obs.id}"></div>
                    `;
                    container.appendChild(card);
                });
                
                document.getElementById('testAllBtn').disabled = false;
                
            } catch (error) {
                container.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        async function testAIAnalysis(observation) {
            const card = document.getElementById(`obs-${observation.id}`);
            const analysisDiv = document.getElementById(`analysis-${observation.id}`);
            
            card.className = 'observation-card processing';
            analysisDiv.innerHTML = '<p>üîÑ Testing AI analysis...</p>';
            
            try {
                // First, check if observation already has AI analysis
                const obsResponse = await fetch(`/api/observations/${observation.id}`, {
                    credentials: 'include'
                });
                
                const obsData = await obsResponse.json();
                let hasExistingAnalysis = false;
                
                if (obsData.aiAnalysis) {
                    hasExistingAnalysis = true;
                    analysisDiv.innerHTML += `<p>‚úÖ Found existing AI analysis in database</p>`;
                }
                
                // Now call AI analysis API
                const response = await fetch('/api/ai/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        observationData: {
                            id: observation.id,
                            nameOfTeacher: observation.nameOfTeacher || 'Teacher',
                            subject: observation.subject || 'Subject',
                            school: observation.school || 'School',
                            grade: observation.grade || 4
                        },
                        language: 'km'
                    }),
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`AI Analysis failed: ${response.status}`);
                }
                
                const analysis = await response.json();
                
                if (analysis.cached) {
                    card.className = 'observation-card cached';
                    analysisDiv.innerHTML = `
                        <p>‚úÖ <strong>AI Analysis Result:</strong> <span class="status cached">CACHED</span></p>
                        <p>Score: ${analysis.overallScore}/10 | Level: ${analysis.performanceLevel}</p>
                        <p>Cached at: ${new Date(analysis.cachedAt).toLocaleString()}</p>
                    `;
                } else {
                    card.className = 'observation-card success';
                    analysisDiv.innerHTML = `
                        <p>‚úÖ <strong>AI Analysis Result:</strong> <span class="status new">NEW</span></p>
                        <p>Score: ${analysis.overallScore}/10 | Level: ${analysis.performanceLevel}</p>
                        <p>Newly generated and saved to database</p>
                    `;
                }
                
                return { 
                    id: observation.id, 
                    success: true, 
                    cached: analysis.cached,
                    hasExistingAnalysis 
                };
                
            } catch (error) {
                card.className = 'observation-card error';
                analysisDiv.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
                return { 
                    id: observation.id, 
                    success: false, 
                    error: error.message 
                };
            }
        }
        
        async function testAllObservations() {
            const testObservations = observations.slice(0, 5); // Test first 5
            const results = [];
            
            document.getElementById('summary').style.display = 'block';
            document.getElementById('summaryContent').innerHTML = '<p>Testing in progress...</p>';
            
            for (const obs of testObservations) {
                const result = await testAIAnalysis(obs);
                results.push(result);
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Display summary
            const successful = results.filter(r => r.success).length;
            const cached = results.filter(r => r.cached).length;
            const newAnalysis = results.filter(r => r.success && !r.cached).length;
            const failed = results.filter(r => !r.success).length;
            
            document.getElementById('summaryContent').innerHTML = `
                <p><strong>Test Complete!</strong></p>
                <p>‚úÖ Successful: ${successful}/${results.length}</p>
                <p>üì¶ Cached (from database): ${cached}</p>
                <p>üÜï New Analysis (saved to database): ${newAnalysis}</p>
                <p>‚ùå Failed: ${failed}</p>
                <hr>
                <p><strong>Key Findings:</strong></p>
                <ul>
                    <li>AI analysis works for ANY observation ID</li>
                    <li>Each observation can have its own AI analysis stored</li>
                    <li>Analysis is cached per observation for performance</li>
                    <li>The system automatically links analysis to the correct observation</li>
                </ul>
            `;
        }
        
        function clearResults() {
            document.getElementById('observations').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('testAllBtn').disabled = true;
            observations = [];
        }
    </script>
</body>
</html>